<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单重定向页面</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 200px; }
        .loading { font-size: 18px; color: #666; }
    </style>
</head>
<body>
    <div class="loading">正在跳转...</div>

    <script>
        // 内置CSV路径
        const CSV_PATH = 'fulitu_images.csv';
        
        // 存储解析后的数据
        let imageData = [];
        
        // 解析CSV数据
        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/);
            const result = [];
            
            // 跳过标题行
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // 处理CSV中的引号和逗号
                    const values = parseCSVLine(line);
                    if (values.length >= 2) {
                        const name = values[0];
                        const urls = values.slice(1).filter(url => url && url.startsWith('http'));
                        if (name && urls.length > 0) {
                            result.push({ name, urls });
                        }
                    }
                }
            }
            
            return result;
        }
        
        // 辅助函数：解析单行CSV（处理引号包围的值）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        // 双引号表示一个实际的引号字符
                        current += '"';
                        i++; // 跳过下一个引号
                    } else {
                        // 切换引号状态
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // 在非引号内的逗号是字段分隔符
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // 添加最后一个字段
            result.push(current.trim());
            return result;
        }
        
        // 直接跳转到随机图片
        function directRedirect() {
            if (imageData.length === 0) {
                console.error("没有加载到任何图片数据");
                document.querySelector('.loading').innerHTML = "<p>错误：没有加载到任何图片数据，请确保页面通过HTTP服务器访问。</p>";
                return;
            }
            
            // 收集所有图片URL
            const allImages = [];
            imageData.forEach(item => {
                item.urls.forEach(url => {
                    allImages.push({ name: item.name, url });
                });
            });
            
            if (allImages.length === 0) {
                console.error("没有找到有效的图片链接");
                document.querySelector('.loading').innerHTML = "<p>错误：没有找到有效的图片链接</p>";
                return;
            }
            
            // 随机选择一个图片
            const randomIndex = Math.floor(Math.random() * allImages.length);
            const selectedImage = allImages[randomIndex];
            
            console.log(`随机选择了: ${selectedImage.name}, 链接: ${selectedImage.url}`);
            
            // 立即执行重定向
            window.location.replace(selectedImage.url);
        }

        // 加载CSV数据并立即重定向
        fetch(CSV_PATH)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                imageData = parseCSV(data);
                console.log(`成功加载 ${imageData.length} 条记录`);
                
                // 立即重定向，不等待用户操作
                directRedirect();
            })
            .catch(error => {
                console.error('加载CSV文件失败:', error);
                document.querySelector('.loading').innerHTML = `
                    <p>错误：无法加载CSV文件。请确保：</p>
                    <ul>
                        <li>此页面通过HTTP服务器提供服务（例如使用 "python -m http.server"）</li>
                        <li>fulitu_images.csv 文件存在于同一目录下</li>
                        <li>文件名正确且服务器配置允许访问该文件</li>
                    </ul>
                    <p>错误详情: ${error.message}</p>
                `;
            });
    </script>
</body>
</html>
